<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>{% block title %}Welcome!{% endblock %}</title>
        <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 128 128%22><text y=%221.2em%22 font-size=%2296%22>⚫️</text><text y=%221.3em%22 x=%220.2em%22 font-size=%2276%22 fill=%22%23fff%22>sf</text></svg>">
        {% block stylesheets %}
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
            <link href="/css/app.css" rel="stylesheet">
        {% endblock %}

        {% block javascripts %}
            <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
            <script src="/js/app.js" defer></script>
        {% endblock %}
    </head>
    <body>
        {% block body %}{% endblock %}
        
        {% if app.user %}
        <script>
            // Verificar estado del usuario periódicamente para detectar kick/ban en tiempo real
            (function() {
                let statusCheckInterval;
                let isChecking = false;
                
                function checkUserStatus() {
                    // Evitar múltiples requests simultáneos
                    if (isChecking) {
                        return;
                    }
                    
                    isChecking = true;
                    
                    fetch('/api/user/status', {
                        method: 'GET',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        credentials: 'same-origin'
                    })
                    .then(response => {
                        // Si la respuesta es 401 o 404, el usuario ya no está autenticado
                        if (response.status === 401 || response.status === 404) {
                            clearInterval(statusCheckInterval);
                            window.location.href = '/kicked';
                            return;
                        }
                        return response.json();
                    })
                    .then(data => {
                        isChecking = false;
                        
                        if (!data || !data.success) {
                            // Si no hay respuesta válida, puede ser que la sesión ya expiró
                            // Esperar un poco antes de redirigir para evitar loops
                            setTimeout(() => {
                                if (window.location.pathname !== '/login' && window.location.pathname !== '/kicked') {
                                    clearInterval(statusCheckInterval);
                                    window.location.href = '/kicked';
                                }
                            }, 1000);
                            return;
                        }
                        
                        // Si el usuario no está activo (baneado)
                        if (!data.isActive) {
                            clearInterval(statusCheckInterval);
                            // Solo redirigir si no estamos ya en la página de baneo
                            if (window.location.pathname !== '/banned') {
                                window.location.href = '/banned';
                            }
                            return;
                        }
                        
                        // NO verificar isOnline aquí - el kick se maneja eliminando sesiones
                        // Si el usuario fue kickeado, sus sesiones fueron eliminadas y no podrá acceder
                        // El estado isOnline puede ser false por otras razones (navegador cerrado, etc.)
                    })
                    .catch(error => {
                        isChecking = false;
                        // No hacer nada en caso de error de red, solo loggear
                        console.error('Error al verificar estado del usuario:', error);
                    });
                }
                
                // Verificar cada 2 segundos
                statusCheckInterval = setInterval(checkUserStatus, 2000);
                
                // Verificar inmediatamente al cargar
                checkUserStatus();
                
                // Limpiar al salir de la página
                window.addEventListener('beforeunload', function() {
                    clearInterval(statusCheckInterval);
                });
            })();
        </script>
        {% endif %}
    </body>
</html>
