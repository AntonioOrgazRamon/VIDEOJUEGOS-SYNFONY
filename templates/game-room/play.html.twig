{% extends 'base.html.twig' %}

{% block title %}4 en Raya - Multijugador{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        .game-room-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 10000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            color: white;
            font-family: 'Arial', sans-serif;
        }

        .game-room-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .game-room-header h1 {
            font-size: 2.5em;
            margin: 0 0 10px 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .players-info {
            display: flex;
            gap: 30px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .player-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            min-width: 200px;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .player-card.active {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.5);
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.3);
        }

        .player-card.winner {
            background: rgba(76, 175, 80, 0.3);
            border-color: #4CAF50;
        }

        .player-name {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .player-status {
            font-size: 0.9em;
            opacity: 0.8;
        }

        .connect4-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .connect4-board {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            background: #1a237e;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .connect4-cell {
            width: 60px;
            height: 60px;
            background: white;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            border: 3px solid #0d47a1;
        }

        .connect4-cell:hover:not(.disabled) {
            transform: scale(1.1);
            box-shadow: 0 0 15px rgba(255,255,255,0.5);
        }

        .connect4-cell.disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }

        .connect4-cell.player1 {
            background: #f44336;
            box-shadow: 0 0 20px rgba(244, 67, 54, 0.6);
        }

        .connect4-cell.player2 {
            background: #ffeb3b;
            box-shadow: 0 0 20px rgba(255, 235, 59, 0.6);
        }

        .game-status {
            text-align: center;
            margin-top: 20px;
            font-size: 1.3em;
            font-weight: bold;
            min-height: 30px;
        }

        .game-status.waiting {
            color: #ffc107;
        }

        .game-status.playing {
            color: #4CAF50;
        }

        .game-status.finished {
            color: #ff9800;
        }

        .leave-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            color: white;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .leave-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }
    </style>
{% endblock %}

{% block body %}
<div class="game-room-overlay">
    <button class="leave-btn" onclick="leaveRoom()" title="Salir de la sala">‚úï</button>
    
    <div class="game-room-header">
        <h1>üéÆ 4 en Raya</h1>
        <p>Multijugador</p>
    </div>

    <div class="players-info">
        <div class="player-card" id="player1Card">
            <div class="player-name">{{ room.player1.username }}</div>
            <div class="player-status" id="player1Status">Jugador 1</div>
        </div>
        <div class="player-card" id="player2Card" style="opacity: 0.5;">
            <div class="player-name" id="player2Name">
                {% if room.player2 %}
                    {{ room.player2.username }}
                {% else %}
                    Esperando jugador...
                {% endif %}
            </div>
            <div class="player-status" id="player2Status">Jugador 2</div>
        </div>
    </div>

    <div class="connect4-container">
        <div class="connect4-board" id="gameBoard">
            {% for row in 0..5 %}
                {% for col in 0..6 %}
                    <div class="connect4-cell" data-row="{{ row }}" data-col="{{ col }}" onclick="makeMove({{ col }})"></div>
                {% endfor %}
            {% endfor %}
        </div>
        <div class="game-status" id="gameStatus">
            {% if room.status == 'waiting' %}
                Esperando a que se una otro jugador...
            {% elseif room.status == 'playing' %}
                {% if room.currentTurn == user.id %}
                    Es tu turno
                {% else %}
                    Turno del oponente
                {% endif %}
            {% else %}
                Partida finalizada
            {% endif %}
        </div>
    </div>
</div>

<script>
    const roomId = {{ room.id }};
    const currentUserId = {{ user.id }};
    let player1Id = {{ room.player1.id }};
    let player2Id = {{ room.player2 ? room.player2.id : 'null' }};
    let gameState = {{ room.gameState|default('null')|raw }};
    let currentTurn = {{ room.currentTurn|default('null') }};
    let gameStatus = '{{ room.status }}';
    let isMyTurn = false;

    // Inicializar el tablero
    function initBoard() {
        if (!gameState) {
            gameState = {
                board: Array(6).fill(null).map(() => Array(7).fill(0)),
                currentPlayer: 1,
                moves: 0
            };
        }
        renderBoard();
        updateGameStatus();
    }

    // Renderizar el tablero
    function renderBoard() {
        const board = document.getElementById('gameBoard');
        const cells = board.querySelectorAll('.connect4-cell');
        
        cells.forEach((cell, index) => {
            const row = Math.floor(index / 7);
            const col = index % 7;
            const value = gameState.board[row][col];
            
            cell.className = 'connect4-cell';
            if (value === 1) {
                cell.classList.add('player1');
            } else if (value === 2) {
                cell.classList.add('player2');
            }
            
            // Deshabilitar celdas si no es nuestro turno o el juego termin√≥
            if (gameStatus !== 'playing' || !isMyTurn || value !== 0) {
                cell.classList.add('disabled');
            }
        });
    }

    // Actualizar estado del juego
    function updateGameStatus() {
        const statusEl = document.getElementById('gameStatus');
        const player1Card = document.getElementById('player1Card');
        const player2Card = document.getElementById('player2Card');
        
        // Actualizar tarjetas de jugadores
        player1Card.classList.remove('active', 'winner');
        player2Card.classList.remove('active', 'winner');
        
        if (gameStatus === 'waiting') {
            statusEl.textContent = 'Esperando a que se una otro jugador...';
            statusEl.className = 'game-status waiting';
            if (player2Id) {
                document.getElementById('player2Card').style.opacity = '1';
            }
        } else if (gameStatus === 'playing') {
            isMyTurn = currentTurn === currentUserId;
            statusEl.className = 'game-status playing';
            
            if (isMyTurn) {
                statusEl.textContent = 'Es tu turno - Haz clic en una columna';
                if (currentUserId === player1Id) {
                    player1Card.classList.add('active');
                } else {
                    player2Card.classList.add('active');
                }
            } else {
                statusEl.textContent = 'Turno del oponente - Espera...';
                if (currentTurn === player1Id) {
                    player1Card.classList.add('active');
                } else {
                    player2Card.classList.add('active');
                }
            }
        } else if (gameStatus === 'finished') {
            statusEl.className = 'game-status finished';
            const winnerId = {{ room.winnerId|default('null') }};
            if (winnerId === currentUserId) {
                statusEl.textContent = '¬°Has ganado! üéâ';
                if (currentUserId === player1Id) {
                    player1Card.classList.add('winner');
                } else {
                    player2Card.classList.add('winner');
                }
            } else if (winnerId === 0) {
                statusEl.textContent = '¬°Empate! ü§ù';
            } else {
                statusEl.textContent = 'Has perdido üòî';
                if (winnerId === player1Id) {
                    player1Card.classList.add('winner');
                } else {
                    player2Card.classList.add('winner');
                }
            }
        }
        
        renderBoard();
    }

    // Hacer un movimiento
    async function makeMove(column) {
        if (gameStatus !== 'playing' || !isMyTurn) {
            return;
        }

        try {
            const response = await fetch(`/api/game-room/${roomId}/move`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ column: column })
            });

            const data = await response.json();
            
            if (data.success) {
                gameState = data.gameState;
                currentTurn = data.room.currentTurn;
                gameStatus = data.room.status;
                updateGameStatus();
            } else {
                alert(data.message || 'Error al hacer el movimiento');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error al hacer el movimiento');
        }
    }

    // Actualizar estado del juego (polling)
    async function updateGameState() {
        try {
            const response = await fetch(`/api/game-room/${roomId}`);
            const data = await response.json();
            
            if (data.success) {
                const room = data.room;
                gameState = room.gameState || gameState;
                currentTurn = room.currentTurn;
                gameStatus = room.status;
                
                // Actualizar informaci√≥n de los jugadores
                const player1Card = document.getElementById('player1Card');
                const player2Card = document.getElementById('player2Card');
                const player1Name = player1Card.querySelector('.player-name');
                const player2Name = document.getElementById('player2Name');
                const player1Status = document.getElementById('player1Status');
                const player2Status = document.getElementById('player2Status');
                
                // Actualizar player1
                if (room.player1) {
                    player1Name.textContent = room.player1.username;
                    player1Status.textContent = 'Jugador 1';
                }
                
                // Actualizar player2
                if (room.player2) {
                    player2Name.textContent = room.player2.username;
                    player2Status.textContent = 'Jugador 2';
                    player2Card.style.opacity = '1';
                    // Actualizar la variable player2Id si a√∫n no estaba establecida
                    if (!player2Id) {
                        player2Id = room.player2.id;
                    }
                } else {
                    player2Name.textContent = 'Esperando jugador...';
                    player2Status.textContent = 'Jugador 2';
                    player2Card.style.opacity = '0.5';
                }
                
                updateGameStatus();
            }
        } catch (error) {
            console.error('Error al actualizar estado:', error);
        }
    }

    // Salir de la sala
    function leaveRoom() {
        if (confirm('¬øEst√°s seguro de que quieres salir de la sala?')) {
            window.location.href = '/';
        }
    }

    // Inicializar
    initBoard();
    
    // Polling cada 2 segundos
    setInterval(updateGameState, 2000);
    
    // Actualizar inmediatamente
    updateGameState();
</script>
{% endblock %}

