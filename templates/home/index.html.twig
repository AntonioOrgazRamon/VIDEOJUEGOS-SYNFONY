{% extends 'base.html.twig' %}

{% block title %}Plataforma de Juegos{% endblock %}

{% block body %}
<style>
    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.2); }
    }
</style>
<script>
    // Establecer tema e idioma al cargar la pÃ¡gina
    document.body.setAttribute('data-theme', '{{ themeMode }}');
    document.body.setAttribute('data-language', '{{ language }}');
    
    // Variables globales para el badge
    let lastBadgeCount = 0;
    let isUpdatingBadge = false;
    
    // FunciÃ³n para cargar invitaciones de juego (global para que estÃ© disponible en todas las pÃ¡ginas)
    async function loadGameInvitationsBadge() {
        if (isUpdatingBadge) return;
        
        try {
            isUpdatingBadge = true;
            const response = await fetch('/api/game-room/invitations', {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                },
                credentials: 'same-origin'
            });
            
            if (!response.ok) {
                isUpdatingBadge = false;
                return;
            }
            
            const data = await response.json();
            
            const badge = document.getElementById('gameInvitationsBadge');
            if (badge) {
                const currentCount = (data.success && data.invitations && Array.isArray(data.invitations)) ? data.invitations.length : 0;
                
                // Solo actualizar si el nÃºmero cambiÃ³
                if (currentCount !== lastBadgeCount) {
                    lastBadgeCount = currentCount;
                    
                    if (currentCount > 0) {
                        badge.textContent = currentCount;
                        badge.style.display = 'flex';
                        // AÃ±adir animaciÃ³n de pulso solo cuando hay cambios
                        badge.style.animation = 'pulse 1s infinite';
                    } else {
                        badge.style.display = 'none';
                    }
                }
            }
            isUpdatingBadge = false;
        } catch (error) {
            console.error('Error al cargar badge de invitaciones:', error);
            isUpdatingBadge = false;
        }
    }

    // Esperar a que app.js se cargue antes de usar sus funciones
    document.addEventListener('DOMContentLoaded', function() {
        // Las funciones showSuccess, showError, openSettings, etc. estÃ¡n en app.js
        // Si no estÃ¡n disponibles, usar fallbacks
        if (typeof window.showSuccess === 'undefined') {
            window.showSuccess = function(msg) { alert('âœ“ ' + msg); };
        }
        if (typeof window.showError === 'undefined') {
            window.showError = function(msg) { alert('âœ• ' + msg); };
        }
        if (typeof window.showInfo === 'undefined') {
            window.showInfo = function(msg) { alert('â„¹ ' + msg); };
        }
        if (typeof window.showWarning === 'undefined') {
            window.showWarning = function(msg) { alert('âš  ' + msg); };
        }
        
        // Cargar badge de invitaciones en el header
        loadGameInvitationsBadge();
        // Actualizar cada 15 segundos (reducido para evitar sobrecarga)
        let badgeIntervalId = setInterval(loadGameInvitationsBadge, 15000);
        
        // Pausar cuando la pestaÃ±a no estÃ¡ visible
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                if (!badgeIntervalId) {
                    badgeIntervalId = setInterval(loadGameInvitationsBadge, 15000);
                }
            } else {
                if (badgeIntervalId) {
                    clearInterval(badgeIntervalId);
                    badgeIntervalId = null;
                }
            }
        });
        
        // Limpiar al salir
        window.addEventListener('beforeunload', () => {
            if (badgeIntervalId) {
                clearInterval(badgeIntervalId);
            }
        });
    });
</script>

{% if app.user %}
    <div class="main-layout">
        <!-- SecciÃ³n de Juegos (80%) -->
        <div class="games-section">
            <!-- Header -->
            <div class="header">
                <a href="{{ path('app_home') }}" style="text-decoration: none; color: inherit;">
                    <div class="logo" style="cursor: pointer;">
                        <span>Plataforma</span>
                        <span class="logo-circle"></span>
                    </div>
                </a>
                <div class="header-actions">
                    <a href="{{ path('app_friends') }}" class="header-icon" title="Amigos" aria-label="Amigos" id="friendsLink" style="text-decoration: none; color: inherit; display: flex; align-items: center; justify-content: center; position: relative;">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                        </svg>
                        <span id="gameInvitationsBadge" style="position: absolute; top: -5px; right: -5px; background: #f44336; color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 10px; display: none; align-items: center; justify-content: center; font-weight: bold;">0</span>
                    </a>
                    <button class="header-icon search-icon" title="Buscar" id="searchIcon" aria-label="Buscar juegos" type="button">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                    </button>
                    <button class="header-icon favorites-icon" title="Favoritos" id="favoritesIcon" aria-label="Mostrar solo favoritos" type="button">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                        </svg>
                    </button>
                </div>
                <div class="search-box" id="searchBox" style="display: none;" role="search">
                    <input type="text" id="searchInput" placeholder="Buscar por nombre..." value="" aria-label="Buscar juegos" style="padding: 8px 12px; border: 1px solid #b5bac9; border-radius: 6px; width: 300px; font-size: 14px;">
                </div>
            </div>
            
            <!-- Contenedor de Juegos -->
            <div class="games-container">
                <div class="games-grid" id="gamesGrid">
                    {% if gamesToDisplay|length > 0 %}
                        {% for item in gamesToDisplay %}
                            {% set currentGame = item.game %}
                            {% set i = item.cardIndex %}
                            
                            {% if item.type == 'split' %}
                                {# Card dividido (pequeÃ±o) #}
                                <div class="game-card split-card {% if not currentGame.isActive %}game-disabled{% endif %}" 
                                     data-game-id="{{ currentGame.id }}" 
                                     data-is-favorite="{% if currentGame.id in likedGameIds %}true{% else %}false{% endif %}"
                                     data-is-active="{{ currentGame.isActive ? 'true' : 'false' }}"
                                     {% if isAdmin %}data-admin-context="true"{% endif %}
                                     role="button"
                                     tabindex="0"
                                     aria-label="{{ currentGame.name }}{% if not currentGame.isActive %} (Bloqueado){% endif %}"
                                     {% if not currentGame.isActive and not isAdmin %}aria-disabled="true"{% endif %}>
                                    {% if currentGame.icon %}
                                        <img data-src="/{{ currentGame.icon }}" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100'%3E%3Crect width='100' height='100' fill='%23f0f0f0'/%3E%3C/svg%3E" class="game-icon" alt="{{ currentGame.name }}" loading="lazy" onerror="this.onerror=null; this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                        <div class="game-placeholder" style="display: none;"><span>ðŸŽ®</span></div>
                                    {% else %}
                                        <div class="game-placeholder"><span>ðŸŽ®</span></div>
                                    {% endif %}
                                    <div class="game-name-overlay">{{ currentGame.name }}</div>
                                    {% if not currentGame.isActive %}
                                    <div class="game-blocked-overlay">
                                        <div class="game-blocked-text">BLOQUEADO</div>
</div>
                                    {% endif %}
                                    <button class="game-favorite {% if currentGame.id in likedGameIds %}liked{% endif %}" 
                                         data-game-id="{{ currentGame.id }}"
                                         onclick="event.stopPropagation(); toggleLike({{ currentGame.id }}, this);"
                                         aria-label="{% if currentGame.id in likedGameIds %}Quitar de favoritos{% else %}AÃ±adir a favoritos{% endif %}"
                                         type="button">
                                        <svg viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                                        </svg>
                                    </button>
                                </div>
                            {% else %}
                                {# Juego normal #}
                                <div class="game-card {% if not currentGame.isActive %}game-disabled{% endif %}" 
                                     data-game-id="{{ currentGame.id }}" 
                                     data-is-favorite="{% if currentGame.id in likedGameIds %}true{% else %}false{% endif %}"
                                     data-is-active="{{ currentGame.isActive ? 'true' : 'false' }}"
                                     {% if isAdmin %}data-admin-context="true"{% endif %}
                                     role="button"
                                     tabindex="0"
                                     aria-label="{{ currentGame.name }}{% if not currentGame.isActive %} (Bloqueado){% endif %}"
                                     {% if not currentGame.isActive and not isAdmin %}aria-disabled="true"{% endif %}>
                                    {% if currentGame.icon %}
                                        <img data-src="/{{ currentGame.icon }}" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100'%3E%3Crect width='100' height='100' fill='%23f0f0f0'/%3E%3C/svg%3E" class="game-icon" alt="{{ currentGame.name }}" loading="lazy" onerror="this.onerror=null; this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                        <div class="game-placeholder" style="display: none;"><span>ðŸŽ®</span></div>
                                    {% else %}
                                        <div class="game-placeholder"><span>ðŸŽ®</span></div>
                                    {% endif %}
                                    <div class="game-name-overlay">{{ currentGame.name }}</div>
                                    {% if not currentGame.isActive %}
                                    <div class="game-blocked-overlay">
                                        <div class="game-blocked-text">BLOQUEADO</div>
                                    </div>
                                    {% endif %}
                                    <button class="game-favorite {% if currentGame.id in likedGameIds %}liked{% endif %}" 
                                         data-game-id="{{ currentGame.id }}"
                                         onclick="event.stopPropagation(); toggleLike({{ currentGame.id }}, this);"
                                         aria-label="{% if currentGame.id in likedGameIds %}Quitar de favoritos{% else %}AÃ±adir a favoritos{% endif %}"
                                         type="button">
                                        <svg viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                                        </svg>
                                    </button>
                                </div>
                            {% endif %}
                        {% endfor %}
                        
                        <script>
                        (function() {
                            const grid = document.getElementById('gamesGrid');
                            const container = grid.parentElement;
                            let cards = [];
                            
                            function updateCardsList() {
                                cards = Array.from(grid.querySelectorAll('.game-card'));
                            }
                            
                            function hideOverflowCards() {
                                if (!container || !grid) return;
                                
                                updateCardsList();
                                
                                const containerHeight = container.clientHeight;
                                const containerTop = container.getBoundingClientRect().top;
                                const maxBottom = containerTop + containerHeight;
                                
                                cards.forEach(card => {
                                    // Solo ocultar si el card ya estÃ¡ visible (no estÃ¡ oculto por filtros)
                                    const currentDisplay = window.getComputedStyle(card).display;
                                    if (currentDisplay === 'none') {
                                        return; // No tocar los que ya estÃ¡n ocultos por filtros
                                    }
                                    
                                    const cardBottom = card.getBoundingClientRect().bottom;
                                    
                                    if (cardBottom > maxBottom) {
                                        card.style.display = 'none';
                                    } else {
                                        card.style.display = '';
                                    }
                                });
                            }
                            
                            // Esperar a que se renderice completamente
                            if (document.readyState === 'loading') {
                                document.addEventListener('DOMContentLoaded', () => {
                                    setTimeout(hideOverflowCards, 300);
                                });
                            } else {
                                setTimeout(hideOverflowCards, 300);
                            }
                            
                            window.addEventListener('resize', () => {
                                setTimeout(hideOverflowCards, 100);
                            });
                            
                            // Exportar funciÃ³n para uso externo
                            window.hideOverflowCards = hideOverflowCards;
                        })();
                        </script>
                        
                        <script>
                        // FunciÃ³n para actualizar el estado de los juegos
                        function updateGamesStatus(data) {
                            if (data.success && data.games) {
                                Object.keys(data.games).forEach(gameId => {
                                    const gameStatus = data.games[gameId];
                                    const gameCards = document.querySelectorAll(`.game-card[data-game-id="${gameId}"]`);
                                    
                                    gameCards.forEach(card => {
                                        const isActive = gameStatus.isActive === true || gameStatus.isActive === 'true';
                                        const currentIsActive = card.getAttribute('data-is-active') === 'true';
                                        
                                        // Actualizar siempre el atributo para mantener sincronizaciÃ³n
                                        card.setAttribute('data-is-active', isActive ? 'true' : 'false');
                                        
                                        // Solo actualizar visualmente si el estado ha cambiado
                                        if (isActive !== currentIsActive) {
                                            if (isActive) {
                                                // Desbloquear juego
                                                card.classList.remove('game-disabled');
                                                const blockedOverlay = card.querySelector('.game-blocked-overlay');
                                                if (blockedOverlay) {
                                                    blockedOverlay.remove();
                                                }
                                            } else {
                                                // Bloquear juego
                                                card.classList.add('game-disabled');
                                                if (!card.querySelector('.game-blocked-overlay')) {
                                                    const overlay = document.createElement('div');
                                                    overlay.className = 'game-blocked-overlay';
                                                    overlay.innerHTML = '<div class="game-blocked-text">BLOQUEADO</div>';
                                                    card.appendChild(overlay);
                                                }
                                            }
                                            
                                            if (typeof window.debugLog === 'function') {
                                                window.debugLog('Estado del juego actualizado:', gameId, 'Activo:', isActive);
                                            }
                                        }
                                    });
                                    
                                    // Asegurar que los admins tengan el atributo data-admin-context
                                    {% if isAdmin %}
                                    gameCards.forEach(card => {
                                        if (!card.hasAttribute('data-admin-context')) {
                                            card.setAttribute('data-admin-context', 'true');
                                        }
                                    });
                                    {% endif %}
                                });
                            }
                        }
                        
                        // FunciÃ³n para verificar el estado de los juegos
                        // Optimizado: usa cachÃ© HTTP del servidor (5 segundos) para reducir carga
                        function checkGamesStatus() {
                            fetch('/admin/games/status', {
                                method: 'GET',
                                headers: {
                                    'X-Requested-With': 'XMLHttpRequest'
                                },
                                cache: 'default' // Permite usar cachÃ© HTTP del servidor
                            })
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error('Error en la respuesta del servidor');
                                }
                                return response.json();
                            })
                            .then(data => {
                                updateGamesStatus(data);
                            })
                            .catch(error => {
                                if (typeof window.debugError === 'function') {
                                    window.debugError('Error al verificar estado de juegos:', error);
                                }
                            });
                        }
                        
                        // Verificar estado de juegos en tiempo real (polling optimizado cada 5 segundos)
                        // Activo para TODOS los usuarios (admin y normales) para ver cambios en tiempo real
                        // Intervalo aumentado a 5 segundos para reducir carga del servidor
                        let gamesStatusCheck;
                        
                        // Ejecutar inmediatamente al cargar la pÃ¡gina (no esperar 5 segundos)
                        setTimeout(function() {
                            // Primera verificaciÃ³n inmediata
                            checkGamesStatus();
                            
                            // Configurar polling cada 5 segundos (optimizado desde 2s)
                            gamesStatusCheck = setInterval(checkGamesStatus, 5000);
                        }, 100); // Ejecutar despuÃ©s de 100ms para asegurar que el DOM estÃ© listo
                        
                        // MenÃº contextual para admin
                        {% if isAdmin %}
                        window.showAdminMenu = function(event, gameId, gameName, isActive) {
                            if (typeof window.debugLog === 'function') {
                                window.debugLog('showAdminMenu llamado', gameId, gameName, isActive);
                            }
                            
                            // Prevenir el menÃº contextual por defecto
                            event.preventDefault();
                            event.stopPropagation();
                            
                            let menu = document.getElementById('adminContextMenu');
                            if (!menu) {
                                // Crear menÃº si no existe
                                menu = document.createElement('div');
                                menu.id = 'adminContextMenu';
                                menu.className = 'admin-context-menu';
                                document.body.appendChild(menu);
                            }
                            
                            // Convertir isActive a boolean si es string
                            const isActiveBool = isActive === 'true' || isActive === true || isActive === 1;
                            
                            menu.innerHTML = `
                                <div class="admin-context-menu-item" id="toggleGameActive">
                                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                        <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                                        <path d="M10.97 4.97a.235.235 0 0 0-.02.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.061L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-1.071-1.05z"/>
                                    </svg>
                                    <span id="toggleGameText">${isActiveBool ? 'Bloquear Juego' : 'Activar Juego'}</span>
                                </div>
                            `;
                            
                            // Posicionar menÃº
                            menu.style.display = 'block';
                            menu.style.left = (event.clientX || event.pageX) + 'px';
                            menu.style.top = (event.clientY || event.pageY) + 'px';
                            menu.style.zIndex = '10000';
                            
                            // AÃ±adir evento al botÃ³n
                            const toggleBtn = document.getElementById('toggleGameActive');
                            if (toggleBtn) {
                                toggleBtn.onclick = function(e) {
                                    e.preventDefault();
                                    e.stopPropagation();
                                    window.toggleGameActive(gameId);
                                    menu.style.display = 'none';
                                };
                            }
                            
                            // Cerrar menÃº al hacer clic fuera
                            setTimeout(() => {
                                const closeMenu = function(e) {
                                    if (menu && !menu.contains(e.target)) {
                                        menu.style.display = 'none';
                                        document.removeEventListener('click', closeMenu);
                                    }
                                };
                                document.addEventListener('click', closeMenu);
                            }, 100);
                        };
                        
                        window.toggleGameActive = function(gameId) {
                            // Mostrar loading state
                            const gameCards = document.querySelectorAll(`.game-card[data-game-id="${gameId}"]`);
                            gameCards.forEach(card => {
                                card.style.opacity = '0.6';
                                card.style.pointerEvents = 'none';
                            });
                            
                            const fetchFn = (typeof window.fetchWithRetry === 'function') 
                                ? window.fetchWithRetry 
                                : fetch;
                            
                            fetchFn('/admin/game/toggle-active/' + gameId, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-Requested-With': 'XMLHttpRequest'
                                }
                            })
                            .then(data => {
                                // Restaurar estado visual
                                gameCards.forEach(card => {
                                    card.style.opacity = '';
                                    card.style.pointerEvents = '';
                                });
                                
                                if (data.success) {
                                    // Actualizar todos los cards del juego
                                    gameCards.forEach(card => {
                                        card.setAttribute('data-is-active', data.isActive ? 'true' : 'false');
                                        
                                        if (data.isActive) {
                                            card.classList.remove('game-disabled');
                                            // Eliminar overlay de bloqueado
                                            const blockedOverlay = card.querySelector('.game-blocked-overlay');
                                            if (blockedOverlay) {
                                                blockedOverlay.remove();
                                            }
                                        } else {
                                            card.classList.add('game-disabled');
                                            // AÃ±adir overlay de bloqueado si no existe
                                            if (!card.querySelector('.game-blocked-overlay')) {
                                                const overlay = document.createElement('div');
                                                overlay.className = 'game-blocked-overlay';
                                                overlay.innerHTML = '<div class="game-blocked-text">BLOQUEADO</div>';
                                                card.appendChild(overlay);
                                            }
                                        }
                                        
                                        // Asegurar que los admins mantengan el atributo data-admin-context
                                        {% if isAdmin %}
                                        gameCards.forEach(card => {
                                            if (!card.hasAttribute('data-admin-context')) {
                                                card.setAttribute('data-admin-context', 'true');
                                            }
                                        });
                                        {% endif %}
                                    });
                                } else {
                                    if (typeof window.showError === 'function') {
                                        window.showError(data.message || 'Error desconocido');
                                    } else {
                                        alert(data.message || 'Error desconocido');
                                    }
                                }
                            })
                            .catch(error => {
                                // Restaurar estado visual
                                gameCards.forEach(card => {
                                    card.style.opacity = '';
                                    card.style.pointerEvents = '';
                                });
                                
                                if (typeof window.debugError === 'function') {
                                    window.debugError('Error:', error);
                                }
                                if (typeof window.showError === 'function') {
                                    window.showError('Error al cambiar el estado del juego');
                                } else {
                                    alert('Error al cambiar el estado del juego');
                                }
                            });
                        };
                        {% endif %}
                        
                        // Prevenir clic en juegos bloqueados
                        document.addEventListener('click', function(e) {
                            const gameCard = e.target.closest('.game-card.game-disabled');
                            if (gameCard && !gameCard.closest('.admin-context-menu')) {
                                e.preventDefault();
                                e.stopPropagation();
                                return false;
                            }
                        });
                        
                        {% if isAdmin %}
                        // Event delegation para clic derecho en admin (funciona incluso en juegos bloqueados)
                        // Usar event delegation en el contenedor padre para capturar todos los eventos
                        document.addEventListener('DOMContentLoaded', function() {
                            const gamesGrid = document.getElementById('gamesGrid');
                            if (gamesGrid) {
                                // Usar capture phase para capturar el evento antes de que los elementos internos lo bloqueen
                                gamesGrid.addEventListener('contextmenu', function(e) {
                                    // Buscar el card mÃ¡s cercano que tenga data-admin-context
                                    let gameCard = null;
                                    let element = e.target;
                                    
                                    // Buscar desde el target hacia arriba hasta encontrar un game-card con data-admin-context
                                    while (element && element !== gamesGrid) {
                                        if (element.classList && element.classList.contains('game-card')) {
                                            if (element.hasAttribute('data-admin-context')) {
                                                gameCard = element;
                                                break;
                                            }
                                        }
                                        element = element.parentElement;
                                    }
                                    
                                    if (gameCard) {
                                        e.preventDefault();
                                        e.stopPropagation();
                                        
                                        const gameId = parseInt(gameCard.getAttribute('data-game-id'));
                                        const isActive = gameCard.getAttribute('data-is-active') === 'true';
                                        const gameName = gameCard.querySelector('.game-name-overlay')?.textContent || 'Juego';
                                        
                                        if (typeof window.debugLog === 'function') {
                                            window.debugLog('Clic derecho detectado en juego:', gameId, 'Activo:', isActive);
                                        }
                                        
                                        if (gameId && window.showAdminMenu) {
                                            window.showAdminMenu(e, gameId, gameName, isActive);
                                        }
                                        return false;
                                    }
                                }, true); // Usar capture phase (true) para capturar antes de que los elementos internos lo bloqueen
                            }
                        });
                        {% endif %}
                        
                        // Manejar doble clic en las tarjetas de juego para toggle de favoritos
                        document.addEventListener('DOMContentLoaded', function() {
                            // Esperar a que las tarjetas se rendericen
                            setTimeout(function() {
                                const gameCards = document.querySelectorAll('.game-card');
                                
                                gameCards.forEach(card => {
                                    let clickTimer = null;
                                    
                                    // Manejar clic simple (para navegar al juego)
                                    card.addEventListener('click', function(e) {
                                        // Si se hace clic en el corazÃ³n, no hacer nada aquÃ­
                                        if (e.target.closest('.game-favorite')) {
                                            return;
                                        }
                                        
                                        // No permitir clic en juegos bloqueados (excepto para admin con clic derecho)
                                        if (card.classList.contains('game-disabled')) {
                                            return;
                                        }
                                        
                                        // Si es un doble clic, el timer se cancelarÃ¡
                                        if (clickTimer === null) {
                                            clickTimer = setTimeout(function() {
                                                clickTimer = null;
                                                // Navegar al juego
                                                const gameId = parseInt(card.getAttribute('data-game-id'));
                                                if (gameId) {
                                                    window.location.href = '/game/play/' + gameId;
                                                }
                                            }, 300); // 300ms para detectar doble clic
                                        }
                                    });
                                    
                                    // Manejar doble clic para toggle de favoritos
                                    card.addEventListener('dblclick', function(e) {
                                        // No permitir doble clic en juegos bloqueados
                                        if (card.classList.contains('game-disabled')) {
                                            e.preventDefault();
                                            e.stopPropagation();
                                            return;
                                        }
                                        
                                        // Cancelar el clic simple
                                        if (clickTimer !== null) {
                                            clearTimeout(clickTimer);
                                            clickTimer = null;
                                        }
                                        
                                        // Prevenir que se propague
                                        e.preventDefault();
                                        e.stopPropagation();
                                        
                                        // Obtener el gameId y el elemento del corazÃ³n
                                        const gameId = parseInt(card.getAttribute('data-game-id'));
                                        const favoriteIcon = card.querySelector('.game-favorite');
                                        
                                        if (gameId && favoriteIcon) {
                                            toggleLike(gameId, favoriteIcon);
                                        }
                                    });
                                });
                            }, 100);
                        });
                        
                        // Toggle like con actualizaciÃ³n optimista (instantÃ¡nea)
                        window.toggleLike = function(gameId, element) {
                            // Obtener el estado actual
                            const gameCard = element.closest('.game-card');
                            const currentIsFavorite = gameCard ? gameCard.getAttribute('data-is-favorite') === 'true' : false;
                            const newIsFavorite = !currentIsFavorite;
                            
                            // ACTUALIZACIÃ“N OPTIMISTA: Actualizar UI inmediatamente
                            const allGameCards = document.querySelectorAll(`.game-card[data-game-id="${gameId}"]`);
                            allGameCards.forEach(card => {
                                card.setAttribute('data-is-favorite', newIsFavorite ? 'true' : 'false');
                                
                                const favoriteIcon = card.querySelector('.game-favorite');
                                if (favoriteIcon) {
                                    if (newIsFavorite) {
                                        favoriteIcon.classList.add('liked');
                                        const svg = favoriteIcon.querySelector('svg');
                                        if (svg) {
                                            svg.setAttribute('fill', 'currentColor');
                                            svg.removeAttribute('stroke');
                                            svg.removeAttribute('stroke-width');
                                        }
                                    } else {
                                        favoriteIcon.classList.remove('liked');
                                        const svg = favoriteIcon.querySelector('svg');
                                        if (svg) {
                                            svg.setAttribute('fill', 'none');
                                            svg.setAttribute('stroke', '#ef4444');
                                            svg.setAttribute('stroke-width', '2');
                                        }
                                    }
                                }
                                
                                // Si el filtro de favoritos estÃ¡ activo, ocultar/mostrar el card
                                if (window.showFavoritesOnly) {
                                    card.style.display = newIsFavorite ? '' : 'none';
                                }
                                
                                // Re-aplicar filtros despuÃ©s de cambiar favorito
                                if (window.filterGames) {
                                    window.filterGames();
                                }
                            });
                            
                            // Hacer la llamada al servidor
                            const fetchFn = (typeof window.fetchWithRetry === 'function') 
                                ? window.fetchWithRetry 
                                : fetch;
                            
                            fetchFn('/game/toggle-like/' + gameId, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-Requested-With': 'XMLHttpRequest'
                                }
                            })
                            .then(data => {
                                if (data.success) {
                                    // Confirmar que el estado es correcto (ya estÃ¡ actualizado)
                                    // Solo actualizar si hay alguna diferencia
                                    if (data.liked !== newIsFavorite) {
                                        // Revertir si el servidor devuelve un estado diferente
                                        const allGameCards = document.querySelectorAll(`.game-card[data-game-id="${gameId}"]`);
                                        allGameCards.forEach(card => {
                                            card.setAttribute('data-is-favorite', data.liked ? 'true' : 'false');
                                            
                                            const favoriteIcon = card.querySelector('.game-favorite');
                                            if (favoriteIcon) {
                                                if (data.liked) {
                                                    favoriteIcon.classList.add('liked');
                                                    const svg = favoriteIcon.querySelector('svg');
                                                    if (svg) {
                                                        svg.setAttribute('fill', 'currentColor');
                                                        svg.removeAttribute('stroke');
                                                        svg.removeAttribute('stroke-width');
                                                    }
                                                } else {
                                                    favoriteIcon.classList.remove('liked');
                                                    const svg = favoriteIcon.querySelector('svg');
                                                    if (svg) {
                                                        svg.setAttribute('fill', 'none');
                                                        svg.setAttribute('stroke', '#ef4444');
                                                        svg.setAttribute('stroke-width', '2');
                                                    }
                                                }
                                            }
                                            
                                            if (showFavoritesOnly) {
                                                card.style.display = data.liked ? '' : 'none';
                                            }
                                        });
                                    }
                                } else {
                                    // Revertir el cambio si falla
                                    const allGameCards = document.querySelectorAll(`.game-card[data-game-id="${gameId}"]`);
                                    allGameCards.forEach(card => {
                                        card.setAttribute('data-is-favorite', currentIsFavorite ? 'true' : 'false');
                                        
                                        const favoriteIcon = card.querySelector('.game-favorite');
                                        if (favoriteIcon) {
                                            if (currentIsFavorite) {
                                                favoriteIcon.classList.add('liked');
                                                const svg = favoriteIcon.querySelector('svg');
                                                if (svg) {
                                                    svg.setAttribute('fill', 'currentColor');
                                                    svg.removeAttribute('stroke');
                                                    svg.removeAttribute('stroke-width');
                                                }
                                            } else {
                                                favoriteIcon.classList.remove('liked');
                                                const svg = favoriteIcon.querySelector('svg');
                                                if (svg) {
                                                    svg.setAttribute('fill', 'none');
                                                    svg.setAttribute('stroke', '#ef4444');
                                                    svg.setAttribute('stroke-width', '2');
                                                }
                                            }
                                        }
                                        
                                        if (showFavoritesOnly) {
                                            card.style.display = currentIsFavorite ? '' : 'none';
                                        }
                                    });
                                    if (typeof window.showError === 'function') {
                                        window.showError('Error al actualizar favoritos');
                                    } else {
                                        alert('Error al actualizar favoritos');
                                    }
                                }
                            })
                            .catch(error => {
                                console.error('Error:', error);
                                // Revertir el cambio si falla
                                const allGameCards = document.querySelectorAll(`.game-card[data-game-id="${gameId}"]`);
                                allGameCards.forEach(card => {
                                    card.setAttribute('data-is-favorite', currentIsFavorite ? 'true' : 'false');
                                    
                                    const favoriteIcon = card.querySelector('.game-favorite');
                                    if (favoriteIcon) {
                                        if (currentIsFavorite) {
                                            favoriteIcon.classList.add('liked');
                                            const svg = favoriteIcon.querySelector('svg');
                                            if (svg) {
                                                svg.setAttribute('fill', 'currentColor');
                                                svg.removeAttribute('stroke');
                                                svg.removeAttribute('stroke-width');
                                            }
                                        } else {
                                            favoriteIcon.classList.remove('liked');
                                            const svg = favoriteIcon.querySelector('svg');
                                            if (svg) {
                                                svg.setAttribute('fill', 'none');
                                                svg.setAttribute('stroke', '#ef4444');
                                                svg.setAttribute('stroke-width', '2');
                                            }
                                        }
                                    }
                                    
                                    if (showFavoritesOnly) {
                                        card.style.display = currentIsFavorite ? '' : 'none';
                                    }
                                });
                                if (typeof window.showError === 'function') {
                                    window.showError('Error al actualizar favoritos');
                                } else {
                                    alert('Error al actualizar favoritos');
                                }
                            });
                        }
                        
                        // Filtro de favoritos (sin recargar pÃ¡gina) - Variables globales
                        window.showFavoritesOnly = false;
                        window.searchFilter = '';
                        
                        const favoritesIcon = document.getElementById('favoritesIcon');
                        if (favoritesIcon) {
                            favoritesIcon.addEventListener('click', function() {
                                window.showFavoritesOnly = !window.showFavoritesOnly;
                                
                                // Cambiar estilo del icono
                                if (window.showFavoritesOnly) {
                                    favoritesIcon.classList.add('active');
                                    const svg = favoritesIcon.querySelector('svg');
                                    if (svg) {
                                        svg.setAttribute('fill', 'currentColor');
                                    }
                                } else {
                                    favoritesIcon.classList.remove('active');
                                    const svg = favoritesIcon.querySelector('svg');
                                    if (svg) {
                                        svg.setAttribute('fill', 'none');
                                    }
                                }
                                
                                if (window.filterGames) {
                                    window.filterGames();
                                }
                            });
                        }
                        
                        // Filtro de bÃºsqueda
                        const searchIcon = document.getElementById('searchIcon');
                        const searchBox = document.getElementById('searchBox');
                        const searchInput = document.getElementById('searchInput');
                        
                        if (searchIcon && searchBox) {
                            searchIcon.addEventListener('click', function() {
                                if (searchBox.style.display === 'none' || !searchBox.style.display) {
                                    searchBox.style.display = 'block';
                                    if (searchInput) {
                                        searchInput.focus();
                                    }
                                } else {
                                    searchBox.style.display = 'none';
                                    window.searchFilter = '';
                                    if (window.filterGames) {
                                        window.filterGames();
                                    }
                                }
                            });
                        }
                        
                        if (searchInput) {
                            // Aplicar debounce a la bÃºsqueda (300ms)
                            const debouncedFilter = window.debounce ? window.debounce(function(e) {
                                window.searchFilter = e.target.value.trim().toLowerCase();
                                if (window.filterGames) {
                                    window.filterGames();
                                }
                            }, 300) : function(e) {
                                window.searchFilter = e.target.value.trim().toLowerCase();
                                if (window.filterGames) {
                                    window.filterGames();
                                }
                            };
                            
                            searchInput.addEventListener('input', debouncedFilter);
                        }
                        
                        // FunciÃ³n de filtrado global
                        window.filterGames = function() {
                            const gameCards = document.querySelectorAll('.game-card');
                            if (typeof window.debugLog === 'function') {
                                window.debugLog('Filtrando juegos. Total:', gameCards.length, 'Favoritos:', window.showFavoritesOnly, 'BÃºsqueda:', window.searchFilter);
                            }
                            
                            gameCards.forEach(card => {
                                const gameNameElement = card.querySelector('.game-name-overlay');
                                const gameName = gameNameElement ? gameNameElement.textContent.toLowerCase().trim() : '';
                                const isFavorite = card.getAttribute('data-is-favorite') === 'true';
                                
                                let shouldShow = true;
                                
                                // Aplicar filtro de favoritos
                                if (window.showFavoritesOnly) {
                                    shouldShow = isFavorite;
                                }
                                
                                // Aplicar filtro de bÃºsqueda
                                if (window.searchFilter && !gameName.includes(window.searchFilter)) {
                                    shouldShow = false;
                                }
                                
                                // Aplicar el filtro
                                if (shouldShow) {
                                    card.style.display = '';
                                } else {
                                    card.style.display = 'none';
                                }
                            });
                            
                            // Reajustar visibilidad despuÃ©s del filtro (solo ocultar los que no caben)
                            setTimeout(() => {
                                if (window.hideOverflowCards) {
                                    window.hideOverflowCards();
                                }
                                // Reinicializar lazy loading para imÃ¡genes que ahora son visibles
                                if (typeof window.refreshLazyLoading === 'function') {
                                    window.refreshLazyLoading();
                                }
                            }, 100);
                        }
                        
                        // Cerrar bÃºsqueda al hacer clic fuera
                        document.addEventListener('click', function(e) {
                            if (!searchIcon.contains(e.target) && !searchBox.contains(e.target)) {
                                searchBox.style.display = 'none';
                            }
                        });
                        
                        // Las funciones showSuccess, showError, etc. ya estÃ¡n definidas al inicio del body
                        
                        // Actualizar estado del usuario - se inicializarÃ¡ despuÃ©s de que el DOM estÃ© completo
                        function initStatusSelector() {
                            const statusSelect = document.getElementById('statusSelect');
                            if (statusSelect) {
                                console.log('âœ… Selector de estado encontrado, agregando listener...');
                                // Guardar el valor inicial
                                let previousStatus = statusSelect.value;
                                
                                statusSelect.addEventListener('change', function() {
                                    const newStatus = this.value;
                                    const oldStatus = previousStatus;
                                    
                                    console.log('ðŸ”„ Cambio de estado detectado:', oldStatus, '->', newStatus);
                                    
                                    // Deshabilitar el select mientras se procesa
                                    this.disabled = true;
                                    
                                    fetch('{{ path('app_profile_update_status') }}', {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json',
                                            'X-Requested-With': 'XMLHttpRequest'
                                        },
                                        body: JSON.stringify({ status: newStatus })
                                    })
                                    .then(response => {
                                        console.log('ðŸ“¥ Respuesta recibida, status:', response.status);
                                        if (!response.ok) {
                                            throw new Error('HTTP error! status: ' + response.status);
                                        }
                                        return response.json();
                                    })
                                    .then(data => {
                                        console.log('ðŸ“¥ Datos recibidos:', data);
                                        if (typeof window.debugLog === 'function') {
                                            window.debugLog('Respuesta del servidor:', data);
                                        }
                                        
                                        // Rehabilitar el select
                                        this.disabled = false;
                                        
                                        if (data.success) {
                                            // Actualizar el valor anterior
                                            previousStatus = newStatus;
                                            
                                            // Actualizar badge visual
                                            const statusBadge = document.getElementById('statusBadge');
                                            if (statusBadge) {
                                                statusBadge.className = 'badge bg-' + (newStatus === 'active' ? 'success' : (newStatus === 'away' ? 'warning' : 'secondary'));
                                                statusBadge.textContent = newStatus.charAt(0).toUpperCase() + newStatus.slice(1);
                                            }
                                            
                                            console.log('âœ… Estado actualizado correctamente');
                                            
                                            // Mostrar notificaciÃ³n de Ã©xito (silenciosa, sin alert)
                                            if (typeof window.showSuccess === 'function') {
                                                window.showSuccess('Estado actualizado correctamente');
                                            } else {
                                                console.log('Estado actualizado correctamente');
                                            }
                                        } else {
                                            console.error('âŒ Error del servidor:', data.message);
                                            
                                            // Revertir selecciÃ³n
                                            this.value = oldStatus;
                                            
                                            if (typeof window.showError === 'function') {
                                                window.showError('Error al actualizar el estado: ' + (data.message || 'Error desconocido'));
                                            } else {
                                                alert('Error al actualizar el estado: ' + (data.message || 'Error desconocido'));
                                            }
                                        }
                                    })
                                    .catch(error => {
                                        console.error('âŒ Error en la peticiÃ³n:', error);
                                        
                                        // Rehabilitar el select
                                        this.disabled = false;
                                        
                                        // Revertir selecciÃ³n
                                        this.value = oldStatus;
                                        
                                        if (typeof window.debugError === 'function') {
                                            window.debugError('Error:', error);
                                        }
                                        if (typeof window.showError === 'function') {
                                            window.showError('Error al actualizar el estado: ' + error.message);
                                        } else {
                                            alert('Error al actualizar el estado: ' + error.message);
                                        }
                                    });
                                });
                                console.log('âœ… Listener de cambio de estado agregado');
                            } else {
                                console.warn('âš ï¸ Selector de estado no encontrado, reintentando...');
                                // Reintentar despuÃ©s de un breve delay
                                setTimeout(initStatusSelector, 100);
                            }
                        }
                        
                        // Inicializar el selector de estado cuando el DOM estÃ© listo
                        if (document.readyState === 'loading') {
                            document.addEventListener('DOMContentLoaded', initStatusSelector);
                        } else {
                            // Si el DOM ya estÃ¡ cargado, intentar inmediatamente
                            setTimeout(initStatusSelector, 50);
                        }
                        
                        // Subir imagen de perfil
                        const profileImageInput = document.getElementById('profileImageInput');
                        if (profileImageInput) {
                            profileImageInput.addEventListener('change', function(e) {
                                const file = e.target.files[0];
                                if (!file) return;
                                
                                // Validar tamaÃ±o (5MB)
                                if (file.size > 5 * 1024 * 1024) {
                                    if (typeof window.showError === 'function') {
                                        window.showError('El archivo es demasiado grande. MÃ¡ximo 5MB');
                                    } else {
                                        alert('El archivo es demasiado grande. MÃ¡ximo 5MB');
                                    }
                                    this.value = '';
                                    return;
                                }
                                
                                // Validar tipo
                                const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
                                if (!allowedTypes.includes(file.type)) {
                                    if (typeof window.showError === 'function') {
                                        window.showError('Tipo de archivo no vÃ¡lido. Solo se permiten imÃ¡genes (JPEG, PNG, GIF, WebP)');
                                    } else {
                                        alert('Tipo de archivo no vÃ¡lido. Solo se permiten imÃ¡genes (JPEG, PNG, GIF, WebP)');
                                    }
                                    this.value = '';
                                    return;
                                }
                                
                                // Crear FormData
                                const formData = new FormData();
                                formData.append('profile_image', file);
                                
                                // Mostrar indicador de carga
                                const profileImage = document.getElementById('profileImage');
                                const originalSrc = profileImage.tagName === 'IMG' ? profileImage.src : null;
                                if (profileImage.tagName === 'IMG') {
                                    profileImage.style.opacity = '0.5';
                                }
                                
                                // Subir archivo
                                fetch('{{ path('app_profile_upload_image') }}', {
                                    method: 'POST',
                                    body: formData,
                                    headers: {
                                        'X-Requested-With': 'XMLHttpRequest'
                                    }
                                })
                                .then(response => {
                                    if (!response.ok) {
                                        throw new Error('HTTP error! status: ' + response.status);
                                    }
                                    return response.json();
                                })
                                .then(data => {
                                    if (profileImage.tagName === 'IMG') {
                                        profileImage.style.opacity = '1';
                                    }
                                    console.log('Respuesta del servidor:', data);
                                    if (data.success) {
                                        // Actualizar imagen
                                        const imagePath = data.image_path || data.image_path;
                                        if (profileImage.tagName === 'IMG') {
                                            profileImage.src = imagePath + '?t=' + new Date().getTime();
                                        } else {
                                            // Si es un div, convertirlo a img
                                            const newImg = document.createElement('img');
                                            newImg.id = 'profileImage';
                                            newImg.className = 'rounded-circle mb-3';
                                            newImg.style.cssText = 'width: 100px; height: 100px; object-fit: cover; cursor: pointer;';
                                            newImg.src = imagePath + '?t=' + new Date().getTime();
                                            newImg.alt = 'Avatar';
                                            newImg.onerror = function() {
                                                this.src = 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22%3E%3Ccircle cx=%2250%22 cy=%2250%22 r=%2250%22 fill=%22%236c757d%22/%3E%3Ctext x=%2250%22 y=%2250%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22white%22 font-size=%2240%22%3EðŸ‘¤%3C/text%3E%3C/svg%3E';
                                            };
                                            profileImage.parentNode.replaceChild(newImg, profileImage);
                                        }
                                        // Mostrar notificaciÃ³n de Ã©xito
                                        if (typeof window.showSuccess === 'function') {
                                            window.showSuccess('Imagen de perfil actualizada correctamente');
                                        } else {
                                            alert('Imagen de perfil actualizada correctamente');
                                        }
                                    } else {
                                        if (typeof window.showError === 'function') {
                                            window.showError('Error al subir la imagen: ' + (data.message || 'Error desconocido'));
                                        } else {
                                            alert('Error al subir la imagen: ' + (data.message || 'Error desconocido'));
                                        }
                                        if (profileImage.tagName === 'IMG' && originalSrc) {
                                            profileImage.src = originalSrc;
                                        }
                                    }
                                    this.value = '';
                                })
                                .catch(error => {
                                    if (typeof window.debugError === 'function') {
                                        window.debugError('Error:', error);
                                    }
                                    if (profileImage.tagName === 'IMG') {
                                        profileImage.style.opacity = '1';
                                    }
                                    if (typeof window.showError === 'function') {
                                        window.showError('Error al subir la imagen: ' + error.message);
                                    } else {
                                        alert('Error al subir la imagen: ' + error.message);
                                    }
                                    this.value = '';
                                });
                            });
                        }
                        </script>
                    {% else %}
                        <div class="alert alert-info">
                            <p>No hay juegos disponibles en este momento. Los juegos se cargarÃ¡n prÃ³ximamente.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- SecciÃ³n de Perfil (20%) -->
        <div class="profile-section">
            <div class="text-center mb-4">
                <div style="position: relative; display: inline-block;">
                    {% if app.user.profileImage %}
                        <img src="/{{ app.user.profileImage }}" alt="Avatar" id="profileImage" class="rounded-circle mb-3" style="width: 100px; height: 100px; object-fit: cover; cursor: pointer; transition: opacity 0.3s ease;" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22%3E%3Ccircle cx=%2250%22 cy=%2250%22 r=%2250%22 fill=%22%236c757d%22/%3E%3Ctext x=%2250%22 y=%2250%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22white%22 font-size=%2240%22%3EðŸ‘¤%3C/text%3E%3C/svg%3E';">
                    {% else %}
                        <div class="rounded-circle bg-secondary d-inline-flex align-items-center justify-content-center mb-3" id="profileImage" style="width: 100px; height: 100px; cursor: pointer;">
                            <span style="font-size: 48px;">ðŸ‘¤</span>
                        </div>
                    {% endif %}
                    <input type="file" id="profileImageInput" accept="image/jpeg,image/png,image/gif,image/webp" style="display: none;">
                    <button type="button" class="btn btn-sm btn-primary" onclick="document.getElementById('profileImageInput').click();" style="position: absolute; bottom: 10px; right: 0; border-radius: 50%; width: 32px; height: 32px; padding: 0; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.2);" title="Cambiar imagen de perfil">
                        <svg width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M6.002 5.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/>
                            <path d="M2.002 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2h-12zm12 1a1 1 0 0 1 1 1v6.5l-3.777-1.947a.5.5 0 0 0-.577.093l-3.71 3.71-2.66-1.772a.5.5 0 0 0-.63.062L1.002 12V3a1 1 0 0 1 1-1h12z"/>
                        </svg>
                    </button>
                </div>
                <h3 class="mb-1" data-username>{{ app.user.username }}</h3>
                <p class="text-muted small mb-3" data-email>{{ app.user.email }}</p>
            </div>
            
            <div class="mb-4">
                <h5 class="mb-3">Estado</h5>
                <select id="statusSelect" class="form-select form-select-sm mb-2">
                    <option value="active" {% if app.user.status == 'active' %}selected{% endif %}>Activo</option>
                    <option value="away" {% if app.user.status == 'away' %}selected{% endif %}>Ausente</option>
                    <option value="offline" {% if app.user.status == 'offline' %}selected{% endif %}>Desconectado</option>
                </select>
                <span id="statusBadge" class="badge bg-{{ app.user.status == 'active' ? 'success' : (app.user.status == 'away' ? 'warning' : 'secondary') }} mb-2" style="display: inline-block; margin-top: 5px;">
                    {{ app.user.status|capitalize }}
                </span>
                {% if app.user.statusMessage %}
                    <p class="small text-muted">{{ app.user.statusMessage }}</p>
                {% endif %}
            </div>
            
            <div class="mb-4">
                <h5 class="mb-3">Visibilidad</h5>
                <span class="badge bg-info">{{ app.user.visibility|capitalize }}</span>
            </div>
            
            <div class="mb-4">
                <h5 class="mb-3">Miembro desde</h5>
                <p class="small text-muted">
                    {{ app.user.createdAt ? app.user.createdAt|date('d/m/Y') : 'N/A' }}
                </p>
            </div>
            
            <div class="d-grid gap-2">
                {% if isAdmin %}
                <a href="{{ path('app_admin_panel') }}" class="btn btn-outline-warning btn-sm" style="background: linear-gradient(135deg, #ff6b6b 0%, #ff4757 100%); color: white; border: none;">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16" style="margin-right: 5px; vertical-align: middle;">
                        <path d="M8 9a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/>
                        <path d="M8 1a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5zM4.5 4a2.5 2.5 0 1 1 5 0 2.5 2.5 0 0 1-5 0zm7 0a2.5 2.5 0 1 1 5 0 2.5 2.5 0 0 1-5 0z"/>
                        <path d="M2.5 7a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5zm11 0a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5z"/>
                    </svg>
                    Panel Admin
                </a>
                {% endif %}
                <button type="button" class="btn btn-outline-primary btn-sm" id="settingsBtn" onclick="if(window.openSettings){window.openSettings();}else{alert('Error: openSettings no estÃ¡ disponible');} return false;">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16" style="margin-right: 5px; vertical-align: middle;">
                        <path d="M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492zM5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0z"/>
                        <path d="M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l.319-.094c1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52l-.094-.319zm-2.633.283c.246-.835 1.428-.835 1.674 0l.094.319a1.873 1.873 0 0 0 2.693 1.115l.292-.16c.764-.415 1.6.42 1.184 1.185l-.159.292a1.873 1.873 0 0 0 1.116 2.692l.318.094c.835.246.835 1.428 0 1.674l-.319.094a1.873 1.873 0 0 0-1.115 2.693l.16.292c.415.764-.42 1.6-1.185 1.184l-.292-.159a1.873 1.873 0 0 0-2.693 1.116l-.094.319c-.246.835-1.428.835-1.674 0l-.094-.319a1.873 1.873 0 0 0-2.693-1.115l-.292.16c-.764.415-1.6-.42-1.184-1.185l.159-.292A1.873 1.873 0 0 0 1.945 8.93l-.319-.094c-.835-.246-.835-1.428 0-1.674l.319-.094A1.873 1.873 0 0 0 3.06 4.377l-.16-.292c-.415-.764.42-1.6 1.185-1.184l.292.159a1.873 1.873 0 0 0 2.692-1.115l.094-.319z"/>
                    </svg>
                    ConfiguraciÃ³n
                </button>
                <a href="{{ path('app_logout') }}" class="btn btn-outline-danger btn-sm">
                    Cerrar SesiÃ³n
                </a>
            </div>
        </div>
    </div>
    
    <!-- Modal de ConfiguraciÃ³n -->
    <div class="modal fade" id="settingsModal" tabindex="-1" aria-labelledby="settingsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content" style="max-height: 90vh; display: flex; flex-direction: column; border-radius: 12px; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
                <div class="modal-header" style="flex-shrink: 0; background: linear-gradient(135deg, #666F88 0%, #788199 100%); color: white; border: none;">
                    <h5 class="modal-title fw-bold" id="settingsModalLabel">
                        <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16" style="margin-right: 8px; vertical-align: middle;">
                            <path d="M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492zM5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0z"/>
                            <path d="M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l.319-.094c1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52l-.094-.319zm-2.633.283c.246-.835 1.428-.835 1.674 0l.094.319a1.873 1.873 0 0 0 2.693 1.115l.292-.16c.764-.415 1.6.42 1.184 1.185l-.159.292a1.873 1.873 0 0 0 1.116 2.692l.318.094c.835.246.835 1.428 0 1.674l-.319.094a1.873 1.873 0 0 0-1.115 2.693l.16.292c.415.764-.42 1.6-1.185 1.184l-.292-.159a1.873 1.873 0 0 0-2.693 1.116l-.094.319c-.246.835-1.428.835-1.674 0l-.094-.319a1.873 1.873 0 0 0-2.693-1.115l-.292.16c-.764.415-1.6-.42-1.184-1.185l.159-.292A1.873 1.873 0 0 0 1.945 8.93l-.319-.094c-.835-.246-.835-1.428 0-1.674l.319-.094A1.873 1.873 0 0 0 3.06 4.377l-.16-.292c-.415-.764.42-1.6 1.185-1.184l.292.159a1.873 1.873 0 0 0 2.692-1.115l.094-.319z"/>
                        </svg>
                        ConfiguraciÃ³n
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" style="flex: 1; overflow-y: auto; padding: 1.5rem;">
                    <!-- Opciones PrÃ³ximamente -->
                    <div class="row g-3 mb-4">
                        <div class="col-12 col-md-6">
                            <button type="button" class="btn btn-outline-secondary w-100 h-100 d-flex align-items-center justify-content-center p-3" id="toggleThemeBtn" style="min-height: 60px;">
                                <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16" style="margin-right: 8px;">
                                    <path d="M8 11a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/>
                                    <path d="M13.997 8.5a5.5 5.5 0 0 0-11 0 5.5 5.5 0 0 0 11 0zm-1 0a4.5 4.5 0 0 1-9 0 4.5 4.5 0 0 1 9 0z"/>
                                </svg>
                                <div class="text-start">
                                    <div class="fw-semibold" id="themeBtnText">{% if themeMode == 'dark' %}Modo Claro{% else %}Modo Oscuro{% endif %}</div>
                                    <small class="text-muted">{% if themeMode == 'dark' %}Actualmente: Oscuro{% else %}Actualmente: Claro{% endif %}</small>
                                </div>
                            </button>
                        </div>
                        <div class="col-12 col-md-6">
                            <button type="button" class="btn btn-outline-secondary w-100 h-100 d-flex align-items-center justify-content-center p-3" id="toggleLanguageBtn" style="min-height: 60px;">
                                <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16" style="margin-right: 8px;">
                                    <path d="M10.478 1.647a.5.5 0 1 0-.956-.294l-4 13a.5.5 0 0 0 .956.294l4-13zM4.854 4.146a.5.5 0 0 1 0 .708L1.707 8l3.147 3.146a.5.5 0 0 1-.708.708l-3.5-3.5a.5.5 0 0 1 0-.708l3.5-3.5a.5.5 0 0 1 .708 0zm6.292 0a.5.5 0 0 0 0 .708L14.293 8l-3.147 3.146a.5.5 0 0 0 .708.708l3.5-3.5a.5.5 0 0 0 0-.708l-3.5-3.5a.5.5 0 0 0-.708 0z"/>
                                </svg>
                                <div class="text-start">
                                    <div class="fw-semibold" id="languageBtnText">{% if language == 'en' %}Cambiar a EspaÃ±ol{% else %}Cambiar a InglÃ©s{% endif %}</div>
                                    <small class="text-muted">{% if language == 'en' %}Actualmente: InglÃ©s{% else %}Actualmente: EspaÃ±ol{% endif %}</small>
                                </div>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Formularios con AcordeÃ³n -->
                    <div class="accordion" id="settingsAccordion">
                        <!-- Cambiar Nombre -->
                        <div class="accordion-item border rounded mb-3" style="box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                            <h2 class="accordion-header" id="headingUsername">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseUsername" aria-expanded="false" aria-controls="collapseUsername" style="background-color: #f5f6f8; font-weight: 500;">
                                    <svg width="18" height="18" fill="currentColor" viewBox="0 0 16 16" style="margin-right: 10px;">
                                        <path d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0zm4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4zm-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10c-2.29 0-3.516.68-4.168 1.332-.678.678-.83 1.418-.832 1.664h10z"/>
                                    </svg>
                                    <span class="fw-semibold">Cambiar Nombre de Usuario</span>
                                </button>
                            </h2>
                            <div id="collapseUsername" class="accordion-collapse collapse" aria-labelledby="headingUsername" data-bs-parent="#settingsAccordion">
                                <div class="accordion-body p-4">
                                    <form id="changeUsernameForm">
                                        <div class="mb-3">
                                            <label for="currentPasswordUsername" class="form-label fw-semibold">ContraseÃ±a Actual</label>
                                            <input type="password" class="form-control" id="currentPasswordUsername" placeholder="Ingresa tu contraseÃ±a actual" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="newUsername" class="form-label fw-semibold">Nuevo Nombre de Usuario</label>
                                            <input type="text" class="form-control" id="newUsername" value="{{ app.user.username }}" required>
                                        </div>
                                        <button type="submit" class="btn btn-primary w-100" style="background: linear-gradient(135deg, #666F88 0%, #788199 100%); border: none; transition: transform 0.2s, box-shadow 0.2s;">
                                            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16" style="margin-right: 5px; vertical-align: middle;">
                                                <path d="M15.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708.708L14.293 7.5H5.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708l3-3z"/>
                                            </svg>
                                            Cambiar Nombre
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Cambiar Correo -->
                        <div class="accordion-item border rounded mb-3" style="box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                            <h2 class="accordion-header" id="headingEmail">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseEmail" aria-expanded="false" aria-controls="collapseEmail" style="background-color: #f5f6f8; font-weight: 500;">
                                    <svg width="18" height="18" fill="currentColor" viewBox="0 0 16 16" style="margin-right: 10px;">
                                        <path d="M0 4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V4Zm2-1a1 1 0 0 0-1 1v.217l7 4.2 7-4.2V4a1 1 0 0 0-1-1H2Zm13 2.383-4.708 2.825L15 11.105V5.383Zm-.034 6.876-5.64-3.471L8 9.583l-1.326-.795-5.64 3.47A1 1 0 0 0 2 13h12a1 1 0 0 0 .966-.741ZM1 11.105l4.708-2.897L1 5.383v5.722Z"/>
                                    </svg>
                                    <span class="fw-semibold">Cambiar Correo ElectrÃ³nico</span>
                                </button>
                            </h2>
                            <div id="collapseEmail" class="accordion-collapse collapse" aria-labelledby="headingEmail" data-bs-parent="#settingsAccordion">
                                <div class="accordion-body p-4">
                                    <form id="changeEmailForm">
                                        <div class="mb-3">
                                            <label for="currentPasswordEmail" class="form-label fw-semibold">ContraseÃ±a Actual</label>
                                            <input type="password" class="form-control" id="currentPasswordEmail" placeholder="Ingresa tu contraseÃ±a actual" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="newEmail" class="form-label fw-semibold">Nuevo Correo</label>
                                            <input type="email" class="form-control" id="newEmail" value="{{ app.user.email }}" required>
                                        </div>
                                        <button type="submit" class="btn btn-primary w-100">
                                            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16" style="margin-right: 5px; vertical-align: middle;">
                                                <path d="M15.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708.708L14.293 7.5H5.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708l3-3z"/>
                                            </svg>
                                            Cambiar Correo
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Cambiar ContraseÃ±a -->
                        <div class="accordion-item border rounded mb-3" style="box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                            <h2 class="accordion-header" id="headingPassword">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapsePassword" aria-expanded="false" aria-controls="collapsePassword" style="background-color: #f5f6f8; font-weight: 500;">
                                    <svg width="18" height="18" fill="currentColor" viewBox="0 0 16 16" style="margin-right: 10px;">
                                        <path d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2zm3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2zM5 8h6a1 1 0 0 1 1v5a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1V9a1 1 0 0 1 1z"/>
                                    </svg>
                                    <span class="fw-semibold">Cambiar ContraseÃ±a</span>
                                </button>
                            </h2>
                            <div id="collapsePassword" class="accordion-collapse collapse" aria-labelledby="headingPassword" data-bs-parent="#settingsAccordion">
                                <div class="accordion-body p-4">
                                    <form id="changePasswordForm">
                                        <div class="mb-3">
                                            <label for="currentPassword" class="form-label fw-semibold">ContraseÃ±a Actual</label>
                                            <input type="password" class="form-control" id="currentPassword" placeholder="Ingresa tu contraseÃ±a actual" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="newPassword" class="form-label fw-semibold">Nueva ContraseÃ±a</label>
                                            <input type="password" class="form-control" id="newPassword" placeholder="MÃ­nimo 6 caracteres" required>
                                            <small class="form-text text-muted">La contraseÃ±a debe tener al menos 6 caracteres</small>
                                        </div>
                                        <div class="mb-3">
                                            <label for="confirmNewPassword" class="form-label fw-semibold">Confirmar Nueva ContraseÃ±a</label>
                                            <input type="password" class="form-control" id="confirmNewPassword" placeholder="Repite la nueva contraseÃ±a" required>
                                        </div>
                                        <button type="submit" class="btn btn-primary w-100">
                                            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16" style="margin-right: 5px; vertical-align: middle;">
                                                <path d="M15.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708.708L14.293 7.5H5.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708l3-3z"/>
                                            </svg>
                                            Cambiar ContraseÃ±a
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Las funciones openSettings y closeSettings ya estÃ¡n definidas al inicio del body
        
        // AÃ±adir event listener para limpiar el backdrop cuando Bootstrap cierre el modal automÃ¡ticamente
        document.addEventListener('DOMContentLoaded', function() {
            const modalElement = document.getElementById('settingsModal');
            if (modalElement) {
                // Listener para cuando el modal se oculta (evento de Bootstrap)
                modalElement.addEventListener('hidden.bs.modal', function() {
                    if (typeof window.debugLog === 'function') {
                        window.debugLog('Modal cerrado por Bootstrap, limpiando backdrop');
                    }
                    // Limpiar todos los backdrops que puedan quedar
                    const backdrops = document.querySelectorAll('.modal-backdrop');
                    backdrops.forEach(backdrop => {
                        backdrop.remove();
                    });
                    // Restaurar el body
                    document.body.classList.remove('modal-open');
                    document.body.style.overflow = '';
                    document.body.style.paddingRight = '';
                });
                
                // TambiÃ©n limpiar cuando se inicia el cierre
                modalElement.addEventListener('hide.bs.modal', function() {
                    if (typeof window.debugLog === 'function') {
                        window.debugLog('Modal iniciando cierre');
                    }
                });
            }
        });
        
        // AÃ±adir event listener al botÃ³n de configuraciÃ³n (mÃºltiples mÃ©todos para asegurar que funcione)
        function initSettingsButton() {
            const settingsBtn = document.getElementById('settingsBtn');
            if (settingsBtn) {
                if (typeof window.debugLog === 'function') {
                    window.debugLog('BotÃ³n de configuraciÃ³n encontrado, aÃ±adiendo event listener');
                }
                // Remover listeners anteriores si existen
                const newBtn = settingsBtn.cloneNode(true);
                settingsBtn.parentNode.replaceChild(newBtn, settingsBtn);
                
                // AÃ±adir nuevo listener
                newBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    if (typeof window.debugLog === 'function') {
                        window.debugLog('BotÃ³n de configuraciÃ³n clickeado');
                    }
                    if (window.openSettings) {
                        window.openSettings();
                    } else {
                        if (typeof window.debugError === 'function') {
                            window.debugError('window.openSettings no estÃ¡ definido');
                        }
                    }
                });
            } else {
                if (typeof window.debugError === 'function') {
                    window.debugError('BotÃ³n de configuraciÃ³n no encontrado');
                }
            }
        }
        
        // Intentar inicializar inmediatamente
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initSettingsButton);
        } else {
            // DOM ya estÃ¡ listo
            initSettingsButton();
        }
        
        // TambiÃ©n intentar despuÃ©s de un pequeÃ±o delay por si acaso
        setTimeout(initSettingsButton, 100);
        
        // Cambiar nombre de usuario (usar event delegation para que funcione cuando el modal se abre)
        document.addEventListener('submit', function(e) {
            if (typeof window.debugLog === 'function') {
                window.debugLog('=== FORM SUBMIT DETECTED ===', e.target?.id);
            }
            if (e.target && e.target.id === 'changeUsernameForm') {
                if (typeof window.debugLog === 'function') {
                    window.debugLog('=== CHANGE USERNAME FORM SUBMITTED ===');
                }
                e.preventDefault();
                e.stopPropagation();
                
                const currentPassword = document.getElementById('currentPasswordUsername');
                const newUsernameInput = document.getElementById('newUsername');
                
                if (!currentPassword || !newUsernameInput) {
                    if (typeof window.debugError === 'function') {
                        window.debugError('Campos no encontrados:', {currentPassword, newUsernameInput});
                    }
                    if (typeof window.showError === 'function') {
                        window.showError('Error: No se encontraron los campos del formulario');
                    } else {
                        alert('Error: No se encontraron los campos del formulario');
                    }
                    return;
                }
                
                const currentPasswordValue = currentPassword.value.trim();
                const newUsernameValue = newUsernameInput.value.trim();
                
                if (typeof window.debugLog === 'function') {
                    window.debugLog('Datos del formulario:', {
                        currentPassword: currentPasswordValue ? '***' : 'VACÃO',
                        newUsername: newUsernameValue
                    });
                }
                
                // Validar que los campos estÃ©n llenos
                if (!currentPasswordValue) {
                    if (typeof window.debugLog === 'function') {
                        window.debugLog('ValidaciÃ³n fallida: contraseÃ±a vacÃ­a');
                    }
                    if (typeof window.showError === 'function') {
                        window.showError('Debes ingresar tu contraseÃ±a actual');
                    } else {
                        alert('Debes ingresar tu contraseÃ±a actual');
                    }
                    return;
                }
                
                if (!newUsernameValue) {
                    if (typeof window.debugLog === 'function') {
                        window.debugLog('ValidaciÃ³n fallida: nombre de usuario vacÃ­o');
                    }
                    if (typeof window.showError === 'function') {
                        window.showError('Debes ingresar un nuevo nombre de usuario');
                    } else {
                        alert('Debes ingresar un nuevo nombre de usuario');
                    }
                    return;
                }
                
                if (newUsernameValue.length < 3) {
                    if (typeof window.debugLog === 'function') {
                        window.debugLog('ValidaciÃ³n fallida: nombre de usuario muy corto');
                    }
                    if (typeof window.showError === 'function') {
                        window.showError('El nombre de usuario debe tener al menos 3 caracteres');
                    } else {
                        alert('El nombre de usuario debe tener al menos 3 caracteres');
                    }
                    return;
                }
                
                if (typeof window.debugLog === 'function') {
                    window.debugLog('Enviando peticiÃ³n a:', '{{ path('app_profile_change_username') }}');
                    window.debugLog('Body:', {current_password: '***', new_username: newUsernameValue});
                }
            
                fetch('{{ path('app_profile_change_username') }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({
                        current_password: currentPasswordValue,
                        new_username: newUsernameValue
                    })
                })
                .then(response => {
                    if (typeof window.debugLog === 'function') {
                        window.debugLog('=== RESPONSE RECIBIDA ===', response.status);
                    }
                    if (!response.ok) {
                        return response.json().then(data => {
                            if (typeof window.debugError === 'function') {
                                window.debugError('Error del servidor:', data);
                            }
                            throw new Error(data.message || 'Error del servidor');
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    if (typeof window.debugLog === 'function') {
                        window.debugLog('=== DATA RECIBIDA ===', data);
                    }
                    if (data.success) {
                        if (typeof window.showSuccess === 'function') {
                            window.showSuccess('Nombre de usuario actualizado correctamente');
                        } else {
                            alert('Nombre de usuario actualizado correctamente');
                        }
                        // Actualizar el nombre en el perfil sin recargar
                        const usernameElements = document.querySelectorAll('[data-username]');
                        usernameElements.forEach(el => {
                            el.textContent = newUsernameValue;
                        });
                        // Limpiar el formulario
                        document.getElementById('changeUsernameForm').reset();
                    } else {
                        if (typeof window.debugError === 'function') {
                            window.debugError('Error en la respuesta:', data);
                        }
                        if (typeof window.showError === 'function') {
                            window.showError(data.message || 'Error desconocido');
                        } else {
                            alert(data.message || 'Error desconocido');
                        }
                    }
                })
                .catch(error => {
                    if (typeof window.debugError === 'function') {
                        window.debugError('=== ERROR EN FETCH ===', error);
                    }
                    if (typeof window.showError === 'function') {
                        window.showError(error.message || 'Error al cambiar el nombre de usuario');
                    } else {
                        alert(error.message || 'Error al cambiar el nombre de usuario');
                    }
                });
            }
        });
        
        // Cambiar correo
        document.addEventListener('submit', function(e) {
            if (e.target && e.target.id === 'changeEmailForm') {
                e.preventDefault();
                const currentPassword = document.getElementById('currentPasswordEmail').value.trim();
                const newEmail = document.getElementById('newEmail').value.trim();
                
                // Validar que los campos estÃ©n llenos
                if (!currentPassword) {
                    showError('Debes ingresar tu contraseÃ±a actual');
                    return;
                }
                
                if (!newEmail) {
                    showError('Debes ingresar un nuevo correo electrÃ³nico');
                    return;
                }
                
                // Validar formato de email
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(newEmail)) {
                    showError('El formato del correo electrÃ³nico no es vÃ¡lido');
                    return;
                }
                
                fetch('{{ path('app_profile_change_email') }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({
                        current_password: currentPassword,
                        new_email: newEmail
                    })
                })
                .then(response => {
                    if (typeof window.debugLog === 'function') {
                        window.debugLog('Response status:', response.status);
                    }
                    if (!response.ok) {
                        return response.json().then(data => {
                            throw new Error(data.message || 'Error del servidor');
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    if (typeof window.debugLog === 'function') {
                        window.debugLog('Response data:', data);
                    }
                    if (data.success) {
                        showSuccess('Correo actualizado correctamente');
                        // Actualizar el correo en el perfil sin recargar
                        const emailElements = document.querySelectorAll('[data-email]');
                        emailElements.forEach(el => {
                            el.textContent = newEmail;
                        });
                        // Limpiar el formulario
                        document.getElementById('changeEmailForm').reset();
                    } else {
                        showError(data.message || 'Error desconocido');
                    }
                })
                .catch(error => {
                    console.error('Error completo:', error);
                    showError(error.message || 'Error al cambiar el correo');
                });
            }
        });
        
        // Cambiar contraseÃ±a
        document.addEventListener('submit', function(e) {
            if (e.target && e.target.id === 'changePasswordForm') {
                e.preventDefault();
                const currentPassword = document.getElementById('currentPassword').value.trim();
                const newPassword = document.getElementById('newPassword').value;
                const confirmNewPassword = document.getElementById('confirmNewPassword').value;
                
                // Validar que los campos estÃ©n llenos
                if (!currentPassword) {
                    showError('Debes ingresar tu contraseÃ±a actual');
                    return;
                }
                
                if (!newPassword) {
                    showError('Debes ingresar una nueva contraseÃ±a');
                    return;
                }
                
                if (!confirmNewPassword) {
                    showError('Debes confirmar tu nueva contraseÃ±a');
                    return;
                }
                
                if (newPassword !== confirmNewPassword) {
                    showError('Las contraseÃ±as no coinciden');
                    return;
                }
                
                if (newPassword.length < 6) {
                    showError('La contraseÃ±a debe tener al menos 6 caracteres');
                    return;
                }
                
                fetch('{{ path('app_profile_change_password') }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({
                        current_password: currentPassword,
                        new_password: newPassword
                    })
                })
                .then(response => {
                    if (typeof window.debugLog === 'function') {
                        window.debugLog('Response status:', response.status);
                    }
                    if (!response.ok) {
                        return response.json().then(data => {
                            throw new Error(data.message || 'Error del servidor');
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    if (typeof window.debugLog === 'function') {
                        window.debugLog('Response data:', data);
                    }
                    if (data.success) {
                        showSuccess('ContraseÃ±a actualizada correctamente');
                        // Limpiar el formulario
                        document.getElementById('changePasswordForm').reset();
                    } else {
                        showError(data.message || 'Error desconocido');
                    }
                })
                .catch(error => {
                    console.error('Error completo:', error);
                    showError(error.message || 'Error al cambiar la contraseÃ±a');
                });
            }
        });
        
        // Cambiar tema (modo oscuro/claro)
        document.getElementById('toggleThemeBtn')?.addEventListener('click', function() {
            const currentTheme = document.body.getAttribute('data-theme') || 'light';
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            
            fetch('{{ path('app_profile_change_theme') }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({
                    theme_mode: newTheme
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Actualizar el atributo del body
                    document.body.setAttribute('data-theme', newTheme);
                    
                    // Actualizar el texto del botÃ³n
                    const themeBtnText = document.getElementById('themeBtnText');
                    const themeBtn = document.getElementById('toggleThemeBtn');
                    if (themeBtnText) {
                        themeBtnText.textContent = newTheme === 'dark' ? 'Modo Claro' : 'Modo Oscuro';
                    }
                    if (themeBtn) {
                        const small = themeBtn.querySelector('small');
                        if (small) {
                            small.textContent = newTheme === 'dark' ? 'Actualmente: Oscuro' : 'Actualmente: Claro';
                        }
                    }
                    
                    // Mostrar notificaciÃ³n de Ã©xito
                    showSuccess('Tema actualizado correctamente');
                } else {
                    showError(data.message || 'Error desconocido');
                }
            })
            .catch(error => {
                if (typeof window.debugError === 'function') {
                    window.debugError('Error:', error);
                }
                if (typeof window.showError === 'function') {
                    window.showError('Error al cambiar el tema');
                }
            });
        });
        
        // Cambiar idioma
        document.getElementById('toggleLanguageBtn')?.addEventListener('click', function() {
            const currentLanguage = document.body.getAttribute('data-language') || 'es';
            const newLanguage = currentLanguage === 'es' ? 'en' : 'es';
            
            fetch('{{ path('app_profile_change_language') }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({
                    language: newLanguage
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Actualizar el atributo del body
                    document.body.setAttribute('data-language', newLanguage);
                    
                    // Actualizar el texto del botÃ³n
                    const languageBtnText = document.getElementById('languageBtnText');
                    const languageBtn = document.getElementById('toggleLanguageBtn');
                    if (languageBtnText) {
                        languageBtnText.textContent = newLanguage === 'en' ? 'Cambiar a EspaÃ±ol' : 'Cambiar a InglÃ©s';
                    }
                    if (languageBtn) {
                        const small = languageBtn.querySelector('small');
                        if (small) {
                            small.textContent = newLanguage === 'en' ? 'Actualmente: InglÃ©s' : 'Actualmente: EspaÃ±ol';
                        }
                    }
                    
                    // Mostrar notificaciÃ³n de Ã©xito
                    showSuccess('Idioma actualizado correctamente');
                } else {
                    showError(data.message || 'Error desconocido');
                }
            })
            .catch(error => {
                if (typeof window.debugError === 'function') {
                    window.debugError('Error:', error);
                }
                if (typeof window.showError === 'function') {
                    window.showError('Error al cambiar el idioma');
                }
            });
        });
    </script>
{% else %}
    <div class="container mt-5">
        <div class="row">
            <div class="col-12 text-center">
                <h1 class="display-4 mb-4">ðŸŽ® Plataforma de Juegos</h1>
                <p class="lead mb-4">Â¡Ãšnete y disfruta de nuestros juegos!</p>
                <div class="d-grid gap-2 d-md-flex justify-content-md-center">
                    <a href="{{ path('app_register') }}" class="btn btn-primary btn-lg me-md-2">Registrarse</a>
                    <a href="{{ path('app_login') }}" class="btn btn-outline-primary btn-lg">Iniciar SesiÃ³n</a>
                </div>
            </div>
        </div>
</div>
{% endif %}
{% endblock %}
